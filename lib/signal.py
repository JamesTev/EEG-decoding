from ulab import numpy as np
from ulab import scipy as spy

# elliptical 10th order bandpass filter with corner frequencies at (4, 28)Hz
# 0.2dB passband ripple and 60dB stopband atten
SOS_SSVEP_BANDPASS_256HZ = np.array([[ 2.65290346e-03,  1.71382637e-03,  2.65290346e-03,
         1.00000000e+00, -1.63541626e+00,  7.28375144e-01],
       [ 1.00000000e+00, -1.04759984e+00,  1.00000000e+00,
         1.00000000e+00, -1.54625550e+00,  8.11422246e-01],
       [ 1.00000000e+00, -1.99984209e+00,  1.00000000e+00,
         1.00000000e+00, -1.89201448e+00,  9.02608375e-01],
       [ 1.00000000e+00, -1.36643149e+00,  1.00000000e+00,
         1.00000000e+00, -1.52285331e+00,  9.17217377e-01],
       [ 1.00000000e+00, -1.99901272e+00,  1.00000000e+00,
         1.00000000e+00, -1.97148975e+00,  9.75345579e-01],
       [ 1.00000000e+00, -1.44319803e+00,  1.00000000e+00,
         1.00000000e+00, -1.52598399e+00,  9.78322773e-01],
       [ 1.00000000e+00, -1.99836089e+00,  1.00000000e+00,
         1.00000000e+00, -1.98997644e+00,  9.92656780e-01],
       [ 1.00000000e+00, -1.99809251e+00,  1.00000000e+00,
         1.00000000e+00, -1.99593130e+00,  9.98318683e-01]])

SOS_SSVEP_BANDPASS_128HZ = np.array([[ 0.01296177,  0.02139995,  0.01296177,  1.        , -1.12887027,
         0.49738264],
       [ 1.        ,  0.49730727,  1.        ,  1.        , -0.70231689,
         0.68572112],
       [ 1.        , -1.99937858,  1.        ,  1.        , -1.76256882,
         0.80388357],
       [ 1.        , -0.00419373,  1.        ,  1.        , -0.46435738,
         0.86883569],
       [ 1.        , -1.99609143,  1.        ,  1.        , -1.93461515,
         0.94994846],
       [ 1.        , -0.15760301,  1.        ,  1.        , -0.37566405,
         0.96618631],
       [ 1.        , -1.99348136,  1.        ,  1.        , -1.97439955,
         0.98509156],
       [ 1.        , -1.99240012,  1.        ,  1.        , -1.98705134,
         0.99658552]])

def sos_filter(x, sos_coeffs=None, fs=256):
  if sos_coeffs is None:
    if fs == 256:
      sos_coeffs = SOS_SSVEP_BANDPASS_256HZ
    elif fs == 128:
      sos_coeffs = SOS_SSVEP_BANDPASS_128HZ
    else:
      raise ValueError("Unepexcted sampling frequency. Only have SOS filter weights for fs = 64Hz or 256Hz")
  
  return spy.signal.sosfilt(sos_coeffs, x)